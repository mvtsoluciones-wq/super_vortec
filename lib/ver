Future<void> _guardarRegistroTecnico() async {
  if (!_formKey.currentState!.validate()) return;

  // Mostrar círculo de carga
  showDialog(
    context: context,
    barrierDismissible: false,
    builder: (context) => const Center(child: CircularProgressIndicator(color: Color(0xFFD50000))),
  );

  try {
    String clienteId = _idController.text.trim();

    // 1. Guardar o actualizar datos del Cliente
    await FirebaseFirestore.instance.collection('clientes').doc(clienteId).set({
      'nombre': _nameController.text.trim(),
      'email': _emailController.text.trim(),
      'telefono': _phoneController.text.trim(),
      'cedula': clienteId,
      'fecha_registro': FieldValue.serverTimestamp(),
    }, SetOptions(merge: true));

    // 2. Guardar el Vehículo asociado a ese Cliente
    await FirebaseFirestore.instance.collection('vehiculos').doc(_plateController.text.trim()).set({
      'placa': _plateController.text.trim().toUpperCase(),
      'color': _colorController.text.trim().toUpperCase(),
      'anio': _yearController.text.trim(),
      'km': _kmController.text.trim(),
      'observaciones': _obsController.text.trim(),
      'video_recepcion': _videoController.text.trim(),
      'propietario_id': clienteId, // Enlace al cliente
      'en_taller': true,
      'ultima_actualizacion': FieldValue.serverTimestamp(),
    });

    if (!mounted) return;
    Navigator.pop(context); // Quitar círculo de carga

    ScaffoldMessenger.of(context).showSnackBar(
      const SnackBar(content: Text("✅ Registro guardado exitosamente en Super Vortec")),
    );

    // Limpiar campos después de guardar
    _formKey.currentState!.reset();
    
  } catch (e) {
    if (!mounted) return;
    Navigator.pop(context);
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(content: Text("❌ Error al guardar: $e"), backgroundColor: Colors.red),
    );
  }
}